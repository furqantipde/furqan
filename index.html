import { useState, useEffect } from "react";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Select } from "@/components/ui/select";
import { Textarea } from "@/components/ui/textarea";
import { Input } from "@/components/ui/input";
import { Sun, Moon, RefreshCw, Play, Copy } from "lucide-react";
import { motion } from "framer-motion";
import { saveAs } from "file-saver";

// Utility: Fetch currency symbols with flags
const CURRENCIES = [
  { code: "USD", flag: "ðŸ‡ºðŸ‡¸" },
  { code: "EUR", flag: "ðŸ‡ªðŸ‡º" },
  { code: "GBP", flag: "ðŸ‡¬ðŸ‡§" },
  { code: "JPY", flag: "ðŸ‡¯ðŸ‡µ" },
  { code: "AUD", flag: "ðŸ‡¦ðŸ‡º" },
  { code: "CAD", flag: "ðŸ‡¨ðŸ‡¦" },
  { code: "CHF", flag: "ðŸ‡¨ðŸ‡­" },
  { code: "CNY", flag: "ðŸ‡¨ðŸ‡³" },
  { code: "INR", flag: "ðŸ‡®ðŸ‡³" },
  { code: "PKR", flag: "ðŸ‡µðŸ‡°" },
];

// Compiler language mapping (Judge0 IDs)
const LANGUAGES = [
  { id: 50, name: "C", sample: "#include <stdio.h>\\nint main(){printf(\"Hello C\\n\");return 0;}" },
  { id: 54, name: "C++", sample: "#include <bits/stdc++.h>\\nusing namespace std;int main(){cout<<\"Hello C++\\n\";}" },
  { id: 71, name: "Python", sample: "print(\"Hello Python\")" },
  { id: 63, name: "JavaScript", sample: "console.log(\"Hello JS\")" },
  { id: 62, name: "Java", sample: "class Main{public static void main(String[]a){System.out.println(\"Hello Java\");}}" },
  { id: 73, name: "Rust", sample: "fn main(){println!(\"Hello Rust\");}" },
  { id: 76, name: "C#", sample: "using System;class P{static void Main(){Console.WriteLine(\"Hello C#\");}}" }
];

export default function App() {
  const [theme, setTheme] = useState("dark");

  // Converter state
  const [amount, setAmount] = useState(1);
  const [from, setFrom] = useState("USD");
  const [to, setTo] = useState("PKR");
  const [result, setResult] = useState("â€”");
  const [rateInfo, setRateInfo] = useState("");

  // Compiler state
  const [lang, setLang] = useState(LANGUAGES[0]);
  const [code, setCode] = useState(LANGUAGES[0].sample);
  const [stdin, setStdin] = useState("");
  const [output, setOutput] = useState("Output will appear here.");

  // Theme toggle
  useEffect(() => {
    document.documentElement.classList.toggle("dark", theme === "dark");
  }, [theme]);

  // Converter
  async function convert() {
    setResult("Converting...");
    try {
      const res = await fetch(`https://api.exchangerate.host/convert?from=${from}&to=${to}&amount=${amount}`);
      const data = await res.json();
      setRateInfo(`1 ${from} = ${data.info.rate} ${to}`);
      setResult(`${amount} ${from} â‰ˆ ${data.result.toLocaleString()} ${to}`);
    } catch (e) {
      setResult("Error fetching rates");
    }
  }

  function exportCSV() {
    const csv = `Amount,From,To,Result\\n${amount},${from},${to},${result}`;
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    saveAs(blob, "conversion.csv");
  }

  // Compiler (via Node backend proxy)
  async function runCode() {
    setOutput("Running...");
    try {
      const res = await fetch("/api/compile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ language_id: lang.id, source_code: code, stdin }),
      });
      const data = await res.json();
      setOutput(data.output || "No output");
    } catch (e) {
      setOutput("Error running code");
    }
  }

  return (
    <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="min-h-screen bg-gradient-to-b from-gray-900 to-gray-800 dark:from-gray-950 dark:to-black text-gray-100 p-6">
      <header className="flex justify-between items-center">
        <h1 className="text-xl font-bold">Currency Converter + Compiler</h1>
        <div className="flex gap-2">
          <Button onClick={() => setTheme(theme === "dark" ? "light" : "dark")}>
            {theme === "dark" ? <Sun /> : <Moon />}
          </Button>
          <Button onClick={exportCSV}>Export CSV</Button>
        </div>
      </header>

      <div className="grid md:grid-cols-2 gap-6 mt-6">
        {/* Converter */}
        <Card className="p-4 space-y-3">
          <h2 className="font-semibold">Currency Converter</h2>
          <div className="flex gap-2">
            <Input type="number" value={amount} onChange={e => setAmount(e.target.value)} />
            <Select value={from} onChange={e => setFrom(e.target.value)}>
              {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.flag} {c.code}</option>)}
            </Select>
            <Button variant="outline" onClick={() => { setFrom(to); setTo(from); }}> <RefreshCw /> </Button>
            <Select value={to} onChange={e => setTo(e.target.value)}>
              {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.flag} {c.code}</option>)}
            </Select>
          </div>
          <Button onClick={convert}>Convert</Button>
          <div>{result}</div>
          <div className="text-xs text-gray-400">{rateInfo}</div>
        </Card>

        {/* Compiler */}
        <Card className="p-4 space-y-3">
          <h2 className="font-semibold">Online Compiler</h2>
          <Select value={lang.name} onChange={e => {
            const l = LANGUAGES.find(x => x.name === e.target.value);
            setLang(l); setCode(l.sample);
          }}>
            {LANGUAGES.map(l => <option key={l.id}>{l.name}</option>)}
          </Select>
          <Textarea rows={10} value={code} onChange={e => setCode(e.target.value)} />
          <Input placeholder="Stdin (optional)" value={stdin} onChange={e => setStdin(e.target.value)} />
          <div className="flex gap-2">
            <Button onClick={runCode}><Play /> Run</Button>
            <Button onClick={() => {navigator.clipboard.writeText(code)}}><Copy /> Copy</Button>
          </div>
          <pre className="bg-black/40 p-2 rounded text-xs whitespace-pre-wrap">{output}</pre>
        </Card>
      </div>
    </motion.div>
  );
}

/* ---------------- Node.js backend example (/api/compile) ----------------
import express from "express";
import fetch from "node-fetch";
const app = express();
app.use(express.json());

app.post("/api/compile", async (req,res)=>{
  try{
    const { language_id, source_code, stdin } = req.body;
    const payload = {
      language_id,
      source_code: Buffer.from(source_code).toString("base64"),
      stdin: Buffer.from(stdin || "").toString("base64"),
    };
    const r = await fetch("https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=true&wait=true",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-RapidAPI-Key": "YOUR_KEY",
        "X-RapidAPI-Host": "judge0-ce.p.rapidapi.com"
      },
      body: JSON.stringify(payload)
    });
    const d = await r.json();
    const decode = s=> s? Buffer.from(s,"base64").toString():"";
    res.json({
      output: `${decode(d.compile_output)}${decode(d.stderr)}${decode(d.stdout)}`
    });
  }catch(err){
    res.status(500).json({output: "Server error"});
  }
});

app.listen(3001,()=>console.log("Compiler proxy running on 3001"));
------------------------------------------------------------------------ */

